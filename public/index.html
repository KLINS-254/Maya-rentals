<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard - HOENGAGER RTX</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<style>
/* Keep all your previous CSS here as in your original index.html */
</style>
</head>
<body>

<script>
// --- Redirect if not logged in ---
if(localStorage.getItem("loggedIn")!=="true"){
    window.location.href="auth.html";
}

// --- Firebase Initialization ---
const firebaseConfig = {
  apiKey: "AIzaSyCdX336VfLzIMZItn8eafwrPBlrBSKpxf0",
  authDomain: "flutter-ai-playground-51023.firebaseapp.com",
  projectId: "flutter-ai-playground-51023",
  storageBucket: "flutter-ai-playground-51023.appspot.com",
  messagingSenderId: "589068038917",
  appId: "1:589068038917:web:b842384a52ec87c8213d6c"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// --- Current user code ---
let userCode = localStorage.getItem("userCode") || "USER123"; // Replace "USER123" for testing

// --- Real-time dashboard updates ---
function updateDashboardRealtime(){
    if(!userCode) return;

    db.collection("users").doc(userCode)
      .onSnapshot(doc=>{
        if(doc.exists){
            const data = doc.data();
            const availableBalance = data.balance || 0;
            const depositAmount = data.totalDeposit || 0;
            const withdrawalAmount = data.totalWithdraw || 0;
            const todaysEarnings = data.todaysEarnings || 0;

            // Dashboard cards
            const cards = document.querySelectorAll(".dashboard-grid .card");
            cards[0].querySelector(".card-value").innerText = availableBalance.toLocaleString();
            cards[1].querySelector(".card-value").innerText = todaysEarnings.toLocaleString();
            cards[2].querySelector(".card-value").innerText = depositAmount.toLocaleString();
            cards[3].querySelector(".card-value").innerText = withdrawalAmount.toLocaleString();

            // Wallet section
            document.querySelector(".withdrawal-card .input-box").value = availableBalance.toLocaleString();
        }
    });
}

// --- Call on load ---
document.addEventListener("DOMContentLoaded", updateDashboardRealtime);
</script>

<!-- HOME SECTION -->
<div id="home" class="section active-section">
    <h2><img src="logo.png" alt="Logo" style="width:35px;height:35px;vertical-align:middle;border-radius:8px;"> Home</h2>
    <div class="dashboard-grid">
        <div class="card orange"><div class="card-value">0</div><div class="card-label">Available balance</div></div>
        <div class="card green"><div class="card-value">0</div><div class="card-label">Today's earnings</div></div>
        <div class="card purple"><div class="card-value">0</div><div class="card-label">Deposit amount</div></div>
        <div class="card blue"><div class="card-value">0</div><div class="card-label">Withdrawal amount</div></div>
    </div>
</div>

<!-- PRODUCTS SECTION -->
<div id="product" class="section">
    <h2><img src="logo.png" alt="Logo" style="width:35px;height:35px;vertical-align:middle;border-radius:8px;"> Products</h2>
    <div class="status-card">
        <div class="status-icon-circle"></div>
        <div>
            <div class="status-label">Account Balance</div>
            <div class="status-value">0</div>
        </div>
    </div>
    <div class="product-grid" id="productContainer"></div>
</div>

<!-- WALLET SECTION -->
<div id="wallet" class="section">
    <h2><img src="logo.png" alt="Logo" style="width:35px;height:35px;vertical-align:middle;border-radius:8px;"> Wallet</h2>
    <div class="wallet-grid">
        <!-- Withdraw -->
        <div class="withdrawal-card">
            <div class="title withdraw">WITHDRAW</div>
            <div class="form-group">
                <label class="label">Account Balance</label>
                <input type="text" class="input-box" value="0" readonly>
            </div>
            <div class="form-group">
                <label class="label">Select Account</label>
                <select class="input-box" id="withdrawAccount">
                    <option value="" disabled selected>--Please Select--</option>
                    <option value="mpesa">Mpesa</option>
                    <option value="airtel">Airtel</option>
                    <option value="paypal">Paypal</option>
                </select>
            </div>
            <div class="form-group">
                <label class="label">Withdrawal Amount</label>
                <input type="number" class="input-box" id="withdrawAmount" placeholder="Amount">
            </div>
            <button class="withdraw-btn" id="withdrawBtn">Withdraw Now</button>
        </div>

        <!-- Deposit -->
        <div class="withdrawal-card">
            <div class="title deposit">DEPOSIT</div>
            <div class="form-group">
                <label class="label">Select Account</label>
                <select class="input-box" id="depositAccount">
                    <option value="" disabled selected>--Please Select--</option>
                    <option value="mpesa">Mpesa</option>
                    <option value="airtel">Airtel</option>
                    <option value="paypal">Paypal</option>
                </select>
            </div>
            <div class="form-group">
                <label class="label">Deposit Amount</label>
                <input type="number" class="input-box" id="depositAmount" placeholder="Amount">
                <div class="alert" id="depositAlert">Minimum deposit is KSH 1,300</div>
            </div>
            <button class="withdraw-btn" id="depositBtn">Deposit Now</button>
        </div>
    </div>
</div>

<!-- Deposit Modal -->
<div id="depositModal">
    <div class="deposit-card">
        <span class="close-btn" id="closeModal">Ã—</span>
        <img src="mpesa.png" id="depositLogo" alt="Deposit Logo">
        <div id="depositText">Deposit Details</div>
        <button class="withdraw-btn" id="confirmDepositBtn">Confirm</button>
    </div>
</div>

<!-- PROFILE SECTION -->
<div id="profile" class="section">
    <h2><img src="logo.png" alt="Logo" style="width:35px;height:35px;vertical-align:middle;border-radius:8px;"> Profile</h2>
    <p>User ID: 00001</p>
    <p>Name: John Doe</p>
    <p>Email: johndoe@example.com</p>
    <p>Phone: +254712345678</p>
    <button class="logout-btn" onclick="logout()">Logout</button>
</div>

<!-- BOTTOM NAV -->
<div class="bottom-nav">
    <a href="#" class="nav-item active" data-target="home"><i class="fas fa-house"></i>Home</a>
    <a href="#" class="nav-item" data-target="product"><i class="fas fa-credit-card"></i>Products</a>
    <a href="#" class="nav-item" data-target="wallet"><i class="fas fa-wallet"></i>Wallet</a>
    <a href="#" class="nav-item" data-target="profile"><i class="fas fa-user"></i>Profile</a>
</div>

<script>
// --- Navigation ---
const navItems=document.querySelectorAll(".nav-item");
const sections=document.querySelectorAll(".section");
navItems.forEach(item=>{
    item.addEventListener("click",function(e){
        e.preventDefault();
        navItems.forEach(n=>n.classList.remove("active"));
        this.classList.add("active");
        sections.forEach(s=>s.classList.remove("active-section"));
        document.getElementById(this.dataset.target).classList.add("active-section");
    });
});

// --- Logout ---
function logout(){
    localStorage.removeItem("loggedIn");
    window.location.href="auth.html";
}

// --- Deposit modal functionality ---
const depositBtn = document.getElementById('depositBtn');
const depositModal = document.getElementById('depositModal');
const closeModal = document.getElementById('closeModal');
const depositLogo = document.getElementById('depositLogo');
const depositText = document.getElementById('depositText');
const depositAccountSelect = document.getElementById('depositAccount');
const depositAmountInput = document.getElementById('depositAmount');
const depositAlert = document.getElementById('depositAlert');
const confirmDepositBtn = document.getElementById('confirmDepositBtn');

depositBtn.addEventListener('click', () => {
    const account = depositAccountSelect.value;
    const amount = parseFloat(depositAmountInput.value);

    if(!account){ alert("Please select an account."); return; }
    if(!amount || amount <= 0){ alert("Please enter a valid deposit amount."); return; }
    if(amount < 1300){ depositAlert.style.display = 'block'; setTimeout(()=>depositAlert.style.display='none',3000); return; }

    if(account === "paypal"){ depositLogo.src="paypal.png"; depositText.innerHTML="<b>SERVICE UNDER MAINTENANCE</b>"; depositModal.style.display='flex'; confirmDepositBtn.style.display='none'; return; }

    depositLogo.src = account==="mpesa"?"mpesa.png":"airtel.png";
    depositText.innerText = `Deposit KSH ${amount.toLocaleString()} via ${account.toUpperCase()}`;
    confirmDepositBtn.style.display="block";
    confirmDepositBtn.dataset.amount = amount;
    confirmDepositBtn.dataset.account = account;
    depositModal.style.display='flex';
});

closeModal.addEventListener('click', ()=>depositModal.style.display='none');
depositModal.addEventListener('click',(e)=>{if(e.target===depositModal) depositModal.style.display='none';});

// --- Confirm deposit writes to Firestore ---
confirmDepositBtn.addEventListener('click', ()=>{
    const amount = parseFloat(confirmDepositBtn.dataset.amount);
    if(!amount) return;

    const userRef = db.collection("users").doc(userCode);
    db.runTransaction(async (transaction)=>{
        const doc = await transaction.get(userRef);
        if(!doc.exists){ alert("User not found"); return; }

        const prevBalance = doc.data().balance || 0;
        const prevDeposit = doc.data().totalDeposit || 0;

        transaction.update(userRef, {
            balance: prevBalance + amount,
            totalDeposit: prevDeposit + amount,
            lastDepositAt: firebase.firestore.FieldValue.serverTimestamp()
        });
    }).then(()=>{
        alert(`Deposit of KSH ${amount.toLocaleString()} successful!`);
        depositModal.style.display='none';
    }).catch(err=>console.error(err));
});
</script>

</body>
</html>
